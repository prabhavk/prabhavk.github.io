CREATE TABLE IF NOT EXISTS emtr_jobs (
  job_id      VARCHAR(128) NOT NULL,
  status      ENUM('started','completed','failed') NOT NULL DEFAULT 'started',
  thr         DOUBLE NOT NULL,
  reps        INT NOT NULL,
  max_iter    INT NOT NULL,

  -- Dirichlet priors as individual columns
  d_pi_1      DOUBLE NOT NULL,
  d_pi_2      DOUBLE NOT NULL,
  d_pi_3      DOUBLE NOT NULL,
  d_pi_4      DOUBLE NOT NULL,
  d_m_1       DOUBLE NOT NULL,
  d_m_2       DOUBLE NOT NULL,
  d_m_3       DOUBLE NOT NULL,
  d_m_4       DOUBLE NOT NULL,

  created_at  TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  finished_at DATETIME(6) NULL,
  dur_minutes DECIMAL(10,2) NULL,

  PRIMARY KEY (job_id),
  KEY idx_status_created (status, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;



CREATE TABLE IF NOT EXISTS emtr_all_info (
  job_id            VARCHAR(64) NOT NULL,
  method            ENUM('parsimony','dirichlet','ssh') NOT NULL,

  rep               INT UNSIGNED NULL,
  num_iter          INT UNSIGNED NULL,
  root_name         VARCHAR(64)  NULL,
  ll_init           DOUBLE       NULL,
  ll_final          DOUBLE       NULL,

  root_prob_init    JSON NULL,   -- length-4 array
  root_prob_final   JSON NULL,   -- length-4 array
  trans_prob_init   JSON NULL,   -- map
  trans_prob_final  JSON NULL,   -- map
  ecd_ll_per_iter   JSON NULL,   -- map or array
  raw_json          JSON NULL,   -- original full struct for safety/debug

  created_at        TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  updated_at        TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),

  PRIMARY KEY (job_id, method),
  KEY idx_best_ll   (job_id, ll_final),
  KEY idx_best_rep  (job_id, rep)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;


CREATE TABLE IF NOT EXISTS emtr_init_final (
  id            BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  job_id        VARCHAR(64)     NOT NULL,
  method        ENUM('parsimony','dirichlet','ssh') NOT NULL,
  root          VARCHAR(64)     NOT NULL,
  rep           INT UNSIGNED    NOT NULL,
  iter          INT UNSIGNED    NOT NULL,

  ll_init       DOUBLE NULL,
  ecd_ll_first  DOUBLE NULL,
  ecd_ll_final  DOUBLE NULL,
  ll_final      DOUBLE NULL,

  created_at    TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),

  PRIMARY KEY (id),
  KEY idx_ll_job                 (job_id),
  KEY idx_ll_job_method          (job_id, method),
  KEY idx_ll_job_root            (job_id, root),
  KEY idx_ll_job_method_rep_iter (job_id, method, rep, iter)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS emtr_trees;

CREATE TABLE emtr_trees (
  id           BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  job_id       VARCHAR(128)    NOT NULL,          -- app-enforced relation to emtr_jobs.job_id
  source       VARCHAR(32)     NOT NULL DEFAULT 'familyjoining',
  method       VARCHAR(32)     NOT NULL DEFAULT '5foldcv',  -- flexible
  label        VARCHAR(64)     NULL,

  format       VARCHAR(16)     NOT NULL DEFAULT 'newick',
  tree         MEDIUMTEXT      NOT NULL,

  rep          INT UNSIGNED    NULL,
  iter         INT UNSIGNED    NULL,
  epsilon      DOUBLE          NULL,
  n_leaves     INT UNSIGNED    NULL,
  n_edges      INT UNSIGNED    NULL,
  root_name    VARCHAR(255)    NULL,
  is_current   TINYINT(1)      NOT NULL DEFAULT 0,
  tree_sha256  VARBINARY(32)   NULL,

  created_at   TIMESTAMP(6)    NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  updated_at   TIMESTAMP(6)    NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
                               ON UPDATE CURRENT_TIMESTAMP(6),

  PRIMARY KEY (id),
  KEY idx_job_created (job_id, created_at),
  KEY idx_job_current (job_id, is_current),
  KEY idx_job_rep_iter (job_id, rep, iter),
  KEY idx_sha (tree_sha256)
) ENGINE=InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_0900_ai_ci;
